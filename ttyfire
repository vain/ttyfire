#!/bin/bash

[[ -z "$1" ]] && { echo "Usage: $(basename "$0") <room>" >&2; exit 1; }

session=${1,,}
session="cf_${session//[^a-z0-9]/}"

if screen -ls | sed -rn 's/^\t[^.]+\.(.*)\t.*/\1/p' | grep -q "$session"
then
	cat <<-EOF
	A ttyfire instance for this channel is already running.
	Consider reattaching to that screen session. Unfortunately,
	I cannot do this for you in a comfortable way because the
	window layout is lost.

	(Consider switching from GNU screen to tmux.)
	EOF
	exit 1
fi

tmp=$(mktemp -d)
trap 'cd /; rm -Rf "$tmp"' EXIT
cd "$tmp"

mkfifo 'in'

cat ~/.screenrc - >.screenrc <<EOF
caption string '%{= bk}%t%{= dd}'

split
resize max
screen -t "$1" campfire_room "$1"
# For testing purposes:
#screen -t out bash -c 'while sleep 0.5; do cat in; done'
focus
resize +5
screen -t "Input" ttyfire_pipefiller
EOF

screen -S "$session" -c .screenrc
